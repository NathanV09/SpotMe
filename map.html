<!DOCTYPE html>
<html>
<script src="https://www.gstatic.com/firebasejs/4.3.1/firebase.js"></script>

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
    <link href="bootstrap-glyphs.css" rel="stylesheet">
    <link href="vendor/bootstrap/css/bootstrap.css" rel="stylesheet">

    <title>Distance Matrix service</title>
    <style>
        #right-panel {
            font-family: 'Roboto','sans-serif';
            line-height: 30px;
            padding-left: 10px;
        }
        #right-panel select, #right-panel input {
            font-size: 15px;
        }
        #right-panel select {
            width: 100%;
        }
        #right-panel i {
            font-size: 12px;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #right-panel {
            float: right;
            width: 48%;
            padding-left: 2%;
        }
        #output {
            font-size: 11px;
        }
    </style>
    <script>
        function goToMain(){
            window.location.href = "main.html";
        }
    </script>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" style=>
    <div class="container">
        <a class="navbar-brand" style="margin:0 auto; padding-top:18px" href="#">Cash Requests</a>
        <button class="navbar-toggler" onclick = "goToMain()"style="left:8px; top:18px; position: absolute; color:white; font-size:20px; border:0px"  type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
        </button>
    </div>
</nav>

<div  id="right-panel" style="display: none">
    <div id="inputs">
        <pre>
var origin1=new google.maps.LatLng(uLat, uLng);
var destinationA = new google.maps.LatLng(uLat, uLng);
var destinationB = new google.maps.LatLng(uLat, uLng);
        </pre>
    </div>
    <div>
        <strong>Results</strong>
    </div>
    <div id="output"></div>
</div>
<div id="map"></div>


<script>
    var config = {
        apiKey: "AIzaSyCUjMnWd8szLkDenWZV58BWfmRq0Sm7dMI",
        authDomain: "spotme-a2502.firebaseapp.com",
        databaseURL: "https://spotme-a2502.firebaseio.com",
        projectId: "spotme-a2502",
        storageBucket: "spotme-a2502.appspot.com",
        messagingSenderId: "1041315357650"
    };
    firebase.initializeApp(config);
    var loc_array=[];
    var user_id_array=[];
    console.log('fes')


//    firebase.database().update()//or set


    var uLat;
    var uLng;
    var origin1;
    function displayLoc(lat, long) {
        uLat=lat;
        uLng=long;
    }
    function initMap() {
        firebase.database().ref("/orders/").once("value").then(function (snapshot) {
            console.log('li')
            for (var user_id in snapshot.val()) {
                if (snapshot.val().hasOwnProperty(user_id)) {
                    var user = snapshot.val()[user_id];
                    loc_array.push([user["location"]["lat"], user["location"]["long"]]);
                    user_id_array.push(user_id);
                    console.log(user["location"]["lat"] + " " + user["location"]["long"]);
                }
            }
            moreMapInit()
        });
    }

    function moreMapInit(){
        var bounds = new google.maps.LatLngBounds;
        origin1 = new google.maps.LatLng(uLat, uLng);
        console.log("origin1: ", origin1);
        var lat1=uLat+0.006;
        var lat2=uLat-0.006;
        destinationA=new google.maps.LatLng(lat1, uLng);
        destinationB=new google.maps.LatLng(lat2, uLng);
        for (var i=0;i<loc_array.length;i++){
            loc_array[i]=new google.maps.LatLng(loc_array[i][0], loc_array[i][1]);
        }
        var destinationIcon = 'https://chart.googleapis.com/chart?' +
            'chst=d_map_pin_letter&chld=D|FF0000|000000';
        //destinationIcon.addEventListener("click", function(){window.location.href="customer.html"});
        var originIcon = 'https://chart.googleapis.com/chart?' +
            'chst=d_map_pin_letter&chld=O|FFFF00|000000';
        var map = new google.maps.Map(document.getElementById('map'), {
            center: origin1,
            zoom: 10
        });
        var geocoder = new google.maps.Geocoder;
        var service = new google.maps.DistanceMatrixService;
        service.getDistanceMatrix({
            origins: [origin1],
            destinations: [destinationA, destinationB],
            travelMode: 'WALKING',
            unitSystem: google.maps.UnitSystem.IMPERIAL,
            avoidHighways: false,
            avoidTolls: false
        }, function (response, status) {
            if (status !== 'OK') {
                alert('Error was: ' + status);
            } else {
                var originList = response.originAddresses;
                var destinationList = response.destinationAddresses;
                var outputDiv = document.getElementById('output');
                outputDiv.innerHTML = '';
                //deleteMarkers(markersArray);
                var showGeocodedAddressOnMap = function (asDestination) {
                    var icon = asDestination ? destinationIcon : originIcon;
                    return function (results, status) {
                        if (status === 'OK') {
                            map.fitBounds(bounds.extend(results[0].geometry.location));
                            var marker = new google.maps.Marker({
                                map: map,
                                position: results[0].geometry.location,
                                icon: icon,
                            });
                            google.maps.event.addListener(marker, 'click', function(){
                                window.location.href="customer.html";
                            });
                            //markersArray.push(marker);
                        } else {
                            alert('Geocode was not successful due to: ' + status);
                        }
                    };
                };
                for (var i = 0; i < originList.length; i++) {
                    var results = response.rows[i].elements;
                    geocoder.geocode({'address': originList[i]},
                        showGeocodedAddressOnMap(false));
                    for (var j = 0; j < results.length; j++) {
                        geocoder.geocode({'address': destinationList[j]},
                            showGeocodedAddressOnMap(true));
                        outputDiv.innerHTML += originList[i] + ' to ' + destinationList[j] +
                            ': ' + results[j].distance.text + ' in ' +
                            results[j].duration.text + '<br>';
                    }
                }
                for (var i = 0; i < loc_array.length; i++) {
                    console.log(user_id_array[i]);
                    var marker = new google.maps.Marker({
                        position: loc_array[i],
                        map: map,
                        user : user_id_array[i],
                        icon: destinationIcon
                    });
                    marker.addListener('click', function(){
                        console.log(JSON.stringify(this.position));
                        console.log(this.user);
                    });
                }
            }
        });
    }


</script>
<script src="Location.js"></script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDR8NLmWg6YsgLwOua4QE83DI1WqxmlH0M&callback=initMap">
</script>
</body>
</html>
</script>